version: '3.8'

services:
  gitlab-runner:
    image: gitlab/gitlab-runner:v18.6.0  # å›ºå®šç‰ˆæœ¬é¿å…å…¼å®¹é—®é¢˜
    container_name: gitlab-runner
    restart: always
    environment:
      # âš ï¸ æ•æ„Ÿä¿¡æ¯å»ºè®®é€šè¿‡ .env æ–‡ä»¶æ³¨å…¥ï¼ˆè§ä¸‹æ–¹è¯´æ˜ï¼‰
      #- REGISTRATION_TOKEN=${GITLAB_REGISTRATION_TOKEN}
      - CI_SERVER_URL=${GITLAB_URL:-https://shylock-server/gitlab/}
      - RUNNER_NAME=${RUNNER_NAME:-docker-runner-prod}
      #- RUNNER_TAG_LIST=${RUNNER_TAGS:-docker,linux,ci}
      - RUNNER_EXECUTOR=docker
      #- DOCKER_IMAGE=alpine:3.18
      # å®‰å…¨åŠ å›ºï¼šç¦æ­¢ç‰¹æƒæ¨¡å¼ï¼ˆå…³é”®ï¼ï¼‰
      - DOCKER_PRIVILEGED=false
      # å¯é€‰ï¼šè®¾ç½®æ„å»ºè¶…æ—¶ï¼ˆç§’ï¼‰
      - BUILDS_DIR=/builds
      - CACHE_DIR=/cache
    volumes:
      # æŒä¹…åŒ– Runner é…ç½®ï¼ˆæ³¨å†Œå config.toml ä¼šå­˜äºæ­¤ï¼‰
      - ./config:/etc/gitlab-runner:Z
      # æŒ‚è½½å®¿ä¸»æœº Docker Socketï¼ˆä½¿ Runner èƒ½åˆ›å»ºæ„å»ºå®¹å™¨ï¼‰
      - /var/run/docker.sock:/var/run/docker.sock:Z
      # æŒ‚è½½æ„å»ºç¼“å­˜ç›®å½•ï¼ˆåŠ é€Ÿåç»­æ„å»ºï¼‰
      - ./cache:/cache:Z
      # æŒ‚è½½æ„å»ºå·¥ä½œç›®å½•ï¼ˆé¿å…å®¹å™¨å†…æ®‹ç•™ï¼‰
      - ./builds:/builds:Z
    #networks:
    #  - ci-network
    network_mode: host
    # å®‰å…¨é™åˆ¶ï¼ˆç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®ï¼‰
    security_opt:
      - no-new-privileges:true
    # èµ„æºé™åˆ¶ï¼ˆé˜²è€—å°½å®¿ä¸»æœºèµ„æºï¼‰
    mem_limit: 16g
    cpus: 8
    # å¥åº·æ£€æŸ¥ï¼ˆç›‘æ§ Runner çŠ¶æ€ï¼‰
    healthcheck:
      test: ["CMD-SHELL", "gitlab-runner status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

#networks:
  #ci-network:
    #driver: bridge
    #ipam:
      #config:
        #- subnet: 172.25.0.0/16

# =============== ä½¿ç”¨å‰å¿…è¯» ===============
# 1ï¸âƒ£ åˆ›å»º .env æ–‡ä»¶ï¼ˆä¸ docker-compose.yml åŒç›®å½•ï¼‰ï¼š
#    GITLAB_URL=https://gitlab.your-company.com/
#    GITLAB_REGISTRATION_TOKEN=glrt-xxxxxx  # ä» GitLab: é¡¹ç›®/ç»„/å®ä¾‹ â†’ Settings â†’ CI/CD â†’ Runners
#    RUNNER_NAME=prod-docker-runner
#    RUNNER_TAGS=docker,linux,prod
#
# 2ï¸âƒ£ é¦–æ¬¡å¯åŠ¨ï¼ˆè‡ªåŠ¨æ³¨å†Œï¼‰ï¼š
#    docker-compose up -d
#    # æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ³¨å†ŒæˆåŠŸï¼šdocker-compose logs -f
#
# 3ï¸âƒ£ åç»­é‡å¯ï¼ˆé…ç½®å·²æŒä¹…åŒ–åœ¨ ./configï¼‰ï¼š
#    docker-compose restart
#
# ğŸ”’ å®‰å…¨åŠ å›ºå»ºè®®ï¼š
#   â€¢ å°† ./config ç›®å½•æƒé™è®¾ä¸º 600ï¼ˆchmod 600 ./config/config.tomlï¼‰
#   â€¢ å®¿ä¸»æœºæ‰§è¡Œï¼šsudo usermod -aG docker gitlab-runnerï¼ˆè‹¥å®¿ä¸»æœºæœ‰ gitlab-runner ç”¨æˆ·ï¼‰
#   â€¢ ç”Ÿäº§ç¯å¢ƒï¼šç”¨ HashiCorp Vault ç­‰ç®¡ç† REGISTRATION_TOKEN
#   â€¢ ç¦ç”¨ç‰¹æƒæ¨¡å¼ï¼šå·²åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½® DOCKER_PRIVILEGED=false
#
# âš ï¸ é‡è¦è­¦å‘Šï¼š
#   â€¢ æŒ‚è½½ /var/run/docker.sock æœ‰å®‰å…¨é£é™©ï¼ç¡®ä¿æ­¤ Runner ä»…è¿è¡Œå¯ä¿¡ä»£ç 
#   â€¢ åˆ‡å‹¿åœ¨å…¬å…±ä»“åº“æäº¤ .env æ–‡ä»¶ï¼å°† .env åŠ å…¥ .gitignore
#   â€¢ å¦‚éœ€æ›´é«˜å®‰å…¨ï¼šæ”¹ç”¨ Kubernetes Executor æˆ– Docker-in-Docker (dind) æ¨¡å¼
#
# ğŸ“š å®˜æ–¹å‚è€ƒï¼š
#   â€¢ æ³¨å†Œå‚æ•°è¯¦è§£ï¼šhttps://docs.gitlab.com/runner/register/#docker
#   â€¢ å®‰å…¨æœ€ä½³å®è·µï¼šhttps://docs.gitlab.com/runner/security/
